{% extends 'base.html.twig' %}

{% block title %}Tous les événements{% endblock %}

{% block body %}
    <div class="contentMargin d-flex justify-content-center flex-column align-items-center gap-3">
        <h3>Panier</h3>

        {% if cartElements %}

            {% set rentals = cartElements|filter(element => element.type == 'rental') %}
            {% set events = cartElements|filter(element => element.type == 'event') %}

            {% if rentals is not empty %}
                <h4>Logements</h4>
                <table class="table">
                    <thead>
                    <tr>
                        <th class="text-center">Image</th>
                        <th class="text-center">Nom</th>
                        <th class="text-center">Date de début</th>
                        <th class="text-center">Date de fin</th>
                        <th class="text-center">Prix par jour</th>
                        <th class="text-center">Prix total</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for elem in rentals %}
                        <tr>
                            <td class="align-middle text-center">
                                <img src="{{ asset('styles/img/' ~ elem.image.getSrc()) }}" alt="{{ asset('styles/img/' ~ elem.image.getAlt()) }}" class="iconImage rounded-4">
                            </td>
                            <td class="align-middle text-center"><a href="{{ path('app_rental', {id: elem.rental.id }) }}">{{ elem.rental.title|capitalize }}</a></td>
                            <td class="align-middle text-center">{{ elem.dateStart|date("d/m/Y") }}</td>
                            <td class="align-middle text-center">{{ elem.dateEnd|date("d/m/Y") }}</td>
                            <td class="align-middle text-center">
                                {% if elem.rental.isOnPromotion %}
                                    {{ (elem.rental.pricePerDay * 0.9)|round(2, 'floor')|number_format(2, ',', '') }}€
                                {% else %}
                                    {{ elem.rental.pricePerDay|round(2, 'floor')|number_format(2, ',', '') }}€
                                {% endif %}
                            </td>
                            <td class="align-middle text-center">
                                {% set days = elem.dateEnd.diff(elem.dateStart).days + 1 %}
                                {% if elem.rental.isOnPromotion %}
                                    {% set dailyPrice = (elem.rental.pricePerDay * 0.9)|round(2, 'floor') %}
                                {% else %}
                                    {% set dailyPrice = elem.rental.pricePerDay|round(2, 'floor') %}
                                {% endif %}

                                {{ (days * dailyPrice)|number_format(2, ',', '') }}€
                            </td>
                            <td class="align-middle text-center">
                                <a href="{{ path('app_delete_element', {id: elem.id}) }}" class="btn btn-red">Supprimer</a>
                            </td>
                        </tr>
                    {% endfor %}

                    </tbody>
                </table>
            {% endif %}

            {% if events is not empty %}
                <h4>Événements</h4>
                <table class="table align-middle-table">
                    <thead>
                    <tr>
                        <th class="text-center">Image</th>
                        <th class="text-center">Nom</th>
                        <th class="text-center">Nombre de places</th>
                        <th class="text-center">Prix par personne</th>
                        <th class="text-center">Prix total</th>
                    </tr>
                    </thead>
                    <tbody>
                    {% for elem in events %}
                        <tr>
                            <td class="align-middle text-center">
                                <img src="{{ asset('styles/img/' ~ elem.image.getSrc()) }}" alt="{{ asset('styles/img/' ~ elem.image.getAlt()) }}" class="iconImage rounded-4">
                            </td>
                            <td class="align-middle text-center"><a href="{{ path('app_event', {id:elem.event.id }) }}">{{ elem.event.title|capitalize }}</a></td>
                            <td class="align-middle text-center">{{ elem.nbPlaces }}</td>
                            <td class="align-middle text-center">
                                {{ elem.event.price|number_format(2, ',', '') }}€
                            </td>
                            <td class="align-middle text-center">
                                {{ (elem.event.price * elem.nbPlaces)|number_format(2, ',', '') }}€
                            </td>
                            <td class="align-middle text-center">
                                <a href="{{ path('app_delete_element', {id: elem.id}) }}" class="btn btn-red">Supprimer</a>
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            {% endif %}

            {% set totalPanier = 0 %}

            {% for elem in rentals %}
                {% set days = elem.dateEnd.diff(elem.dateStart).days + 1 %}
                {% if elem.rental.isOnPromotion %}
                    {% set dailyPrice = (elem.rental.pricePerDay * 0.9)|round(2, 'floor') %}
                {% else %}
                    {% set dailyPrice = elem.rental.pricePerDay|round(2, 'floor') %}
                {% endif %}
                {% set totalPanier = totalPanier + (days * dailyPrice) %}
            {% endfor %}

            {% for elem in events %}
                {% set totalPanier = totalPanier + (elem.event.price * elem.nbPlaces) %}
            {% endfor %}

            <div class="mt-4 text-end">
                <h5>Total du panier : <strong>{{ totalPanier|number_format(2, ',', '') }}€</strong></h5>
            </div>

            <a href="{{ path('app_reset_cart') }}" class="btn btn-red">Vider le panier</a>
        {% else %}
            <p class="alert alert-secondary m-3">Panier vide.</p>
            <a href="{{ path('app_events') }}" class="btn btn-yellow">Voir tous les événements</a>
            <a href="{{ path('app_rentals') }}" class="btn btn-green">Voir tous les Logements</a>
        {% endif %}
    </div>
{% endblock %}
